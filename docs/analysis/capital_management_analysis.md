# 매매 시스템 구조 분석 및 개선 제안서 (Reorganization Report)

## 1. 개요
현재 TwinStar-Quantum 시스템의 자본 관리 및 다중 심볼 매매 로직의 파편화 문제를 해결하고, 사용자 요청에 따른 **복리(Compounding) 및 고정(Fixed) 모드**의 유연한 전환을 지원하기 위한 구조 분석 보고서입니다.

## 2. 현재 상태 분석 (As-Is)

### 2.1 자본 관리 로직
- **UnifiedBot (싱글):** 로컬 파일(`trade_storage`) 기반의 복리 로직이 하드코딩되어 있습니다. 고정 모드 전환이 불가능합니다.
- **MultiTrader (멀티):** 초기 시드의 80%를 균등 배분하는 고정 방식입니다. 수익 발생에 따른 시드 재배분 로직이 없습니다.
- **MultiSniper (스나이퍼):** 거래량 비례 배분 방식이며, 실시간 수익 반영 로직이 없습니다.
- **DualTrackTrader:** BTC는 고정, ALT는 복리로 수동 구현되어 있어 통합 관리가 어렵습니다.

### 2.2 거래소 API 연업
- Bybit/Binance는 API 기반 PnL 조회가 구현되어 있으나, OKX/Bitget 등은 미비하거나 로컬 파일에 의존하고 있어 정확도 이슈가 발생할 수 있습니다.

### 2.3 GUI 문제점
- 사용자가 복리/고정 모드를 선택할 수 있는 UI 요소가 부재합니다.
- 각 코인별 현재 적용된 시드(복리 반영분)를 확인하기 어렵습니다.

## 3. 개선 방향 (To-Be)

### 3.1 공통 모듈 도입 (core/)
- **`capital_manager.py`**: 모든 매매 모듈에서 공통으로 호출하는 자본 관리자. 모드 전환 및 시드 계산을 전담합니다.
- **`trade_common.py`**: `CoinState`, `CoinStatus` 등 중복된 클래스와 상수를 통합하여 코드 재사용성을 80% 이상 향상시킵니다.
- **`pnl_tracker.py`**: API PnL과 로컬 계산 PnL의 오차를 자동으로 보정(Reconciliation)합니다.

### 3.2 리팩토링 단계
1. **1단계 (기반 구축)**: 공통 모듈(`CapitalManager` 등) 생성 및 도입.
2. **2단계 (거래소 강화)**: 모든 거래소 어댑터의 `get_realized_pnl` API 구현 통일.
3. **3단계 (봇 연동)**: `UnifiedBot` 및 `MultiTrader`가 `CapitalManager`를 사용하도록 수정.
4. **4단계 (GUI 개선)**: 설정 화면에 모드 선택 버튼 추가 및 대시보드 시드 표시 업데이트.

## 4. 기대 효과
- **유연성**: 버튼 클릭 한 번으로 전 시스템의 자본 관리 모드 변경 가능.
- **정확성**: API 기반 PnL 동기화로 정확한 수익률 및 복리 계산 보장.
- **유지보수성**: 중복 코드 제거로 버그 발생 가능성 감소 및 기능 확장 용이성 확보.
